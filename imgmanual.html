<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>作業書作成支援ツール</title>
    
    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    
    <!-- Babel (for JSX) -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <style>
        /* --- 印刷用スタイル --- */
        @media print {
            @page { 
                margin: 10mm;
                size: A4; 
            }
            body { 
                background: white; 
                -webkit-print-color-adjust: exact; 
                print-color-adjust: exact;
            }
            
            /* ヘッダーやボタンを隠す */
            .print-hidden { 
                display: none !important; 
            }

            .print-block { 
                display: block !important; 
            }
            
            /* 各ステップのスタイル調整 */
            .step-item {
                break-inside: avoid;
                page-break-inside: avoid;
                border: 1px solid #ddd !important;
                margin-bottom: 15px !important;
                padding: 10px !important;
                height: auto;
                display: flex !important;
                page-break-after: auto;
            }

            /* 横並び（デフォルト）時のスタイル */
            .step-row .step-image-container {
                max-height: 300px;
                width: 50% !important;
                overflow: hidden !important;
            }
            .step-row .step-text-container {
                width: 50% !important;
            }

            /* 縦並び（強調）時のスタイル */
            .step-col {
                flex-direction: column !important;
            }
            .step-col .step-image-container {
                max-height: 500px; /* 縦並び時は画像をより大きく許容 */
                width: 100% !important;
                overflow: hidden !important;
                margin-bottom: 10px;
            }
            .step-col .step-text-container {
                width: 100% !important;
            }

            textarea { 
                border: none !important; 
                resize: none !important; 
                padding: 0 !important;
                overflow: visible !important;
            }
            
            .main-content {
                padding: 0 !important;
                box-shadow: none !important;
            }
            
            .lg\:grid-cols-3 {
                display: block !important;
            }
        }
    </style>
</head>
<body class="bg-gray-50 text-gray-800">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useRef, useEffect } = React;

        // --- Icons ---
        const IconBase = ({ children, size = 20, className = "", ...props }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className} {...props}>
                {children}
            </svg>
        );

        const FileImage = (props) => (<IconBase {...props}><rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect><circle cx="8.5" cy="8.5" r="1.5"></circle><polyline points="21 15 16 10 5 21"></polyline></IconBase>);
        const PlusCircle = (props) => (<IconBase {...props}><circle cx="12" cy="12" r="10"></circle><line x1="12" y1="8" x2="12" y2="16"></line><line x1="8" y1="12" x2="16" y2="12"></line></IconBase>);
        const Trash2 = (props) => (<IconBase {...props}><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path><line x1="10" y1="11" x2="10" y2="17"></line><line x1="14" y1="11" x2="14" y2="17"></line></IconBase>);
        const Printer = (props) => (<IconBase {...props}><polyline points="6 9 6 2 18 2 18 9"></polyline><path d="M6 18H4a2 2 0 0 1-2-2v-5a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2v5a2 2 0 0 1-2 2h-2"></path><rect x="6" y="14" width="12" height="8"></rect></IconBase>);
        const FileText = (props) => (<IconBase {...props}><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline><line x1="16" y1="13" x2="8" y2="13"></line><line x1="16" y1="17" x2="8" y2="17"></line><polyline points="10 9 9 9 8 9"></polyline></IconBase>);
        const Save = (props) => (<IconBase {...props}><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"></path><polyline points="17 21 17 13 7 13 7 21"></polyline><polyline points="7 3 7 8 15 8"></polyline></IconBase>);
        const Upload = (props) => (<IconBase {...props}><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="17 8 12 3 7 8"></polyline><line x1="12" y1="3" x2="12" y2="15"></line></IconBase>);
        const ArrowUp = (props) => (<IconBase {...props}><line x1="12" y1="19" x2="12" y2="5"></line><polyline points="5 12 12 5 19 12"></polyline></IconBase>);
        const ArrowDown = (props) => (<IconBase {...props}><line x1="12" y1="5" x2="12" y2="19"></line><polyline points="19 12 12 19 5 12"></polyline></IconBase>);
        const RotateCw = (props) => (<IconBase {...props}><path d="M23 4v6h-6"></path><path d="M20.49 15a9 9 0 1 1-2.12-9.36L23 10"></path></IconBase>);
        const ZoomIn = (props) => (<IconBase {...props}><circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line><line x1="11" y1="8" x2="11" y2="14"></line><line x1="8" y1="11" x2="14" y2="11"></line></IconBase>);
        const ZoomOut = (props) => (<IconBase {...props}><circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line><line x1="8" y1="11" x2="14" y2="11"></line></IconBase>);
        const RefreshCcw = (props) => (<IconBase {...props}><polyline points="1 4 1 10 7 10"></polyline><polyline points="23 20 23 14 17 14"></polyline><path d="M20.49 9A9 9 0 0 0 5.64 5.64L1 10m22 4l-4.64 4.36A9 9 0 0 1 3.51 15"></path></IconBase>);
        
        // レイアウト切替用アイコン
        const LayoutRow = (props) => (<IconBase {...props}><rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect><line x1="9" y1="3" x2="9" y2="21"></line></IconBase>); // 横並び
        const LayoutCol = (props) => (<IconBase {...props}><rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect><line x1="3" y1="12" x2="21" y2="12"></line></IconBase>); // 縦並び

        // --- Main Component ---
        function App() {
            const [steps, setSteps] = useState([]);
            const [fileName, setFileName] = useState("");
            const [hasUnsavedChanges, setHasUnsavedChanges] = useState(false);
            const [isDragging, setIsDragging] = useState(false);
            
            const [dragState, setDragState] = useState({
                isDragging: false,
                stepIndex: null,
                startX: 0,
                startY: 0,
                initialImgX: 0,
                initialImgY: 0
            });
            
            const fileInputRef = useRef(null);
            const jsonInputRef = useRef(null);

            // 未保存時の警告
            useEffect(() => {
                const handleBeforeUnload = (e) => {
                    if (hasUnsavedChanges && steps.length > 0) {
                        e.preventDefault();
                        e.returnValue = ''; 
                    }
                };
                window.addEventListener('beforeunload', handleBeforeUnload);
                return () => window.removeEventListener('beforeunload', handleBeforeUnload);
            }, [hasUnsavedChanges, steps]);

            // 画像の読み込み処理
            const processFiles = (files) => {
                if (!files || files.length === 0) return;

                const imageFiles = Array.from(files).filter(file => file.type.startsWith('image/'));
                if (imageFiles.length === 0) return;

                let loadedCount = 0;
                const newSteps = [];

                imageFiles.forEach(file => {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        newSteps.push({
                            id: Date.now() + Math.random(),
                            image: e.target.result,
                            text: '',
                            scale: 1, 
                            x: 0, 
                            y: 0,
                            layout: 'row', // 初期レイアウトは横並び
                            timestamp: Date.now()
                        });
                        loadedCount++;
                        
                        if (loadedCount === imageFiles.length) {
                            setSteps(prev => [...prev, ...newSteps]);
                            setHasUnsavedChanges(true);
                        }
                    };
                    reader.readAsDataURL(file);
                });
            };

            const handleFileUpload = (event) => {
                processFiles(event.target.files);
                event.target.value = '';
            };

            const handleDragOver = (e) => {
                e.preventDefault();
                setIsDragging(true);
            };
            const handleDragLeave = (e) => {
                e.preventDefault();
                setIsDragging(false);
            };
            const handleDrop = (e) => {
                e.preventDefault();
                setIsDragging(false);
                processFiles(e.dataTransfer.files);
            };

            // 画像のドラッグ移動ハンドラ
            const handleImageMouseDown = (index, e) => {
                e.preventDefault(); 
                setDragState({
                    isDragging: true,
                    stepIndex: index,
                    startX: e.clientX,
                    startY: e.clientY,
                    initialImgX: steps[index].x || 0,
                    initialImgY: steps[index].y || 0
                });
            };

            const handleImageMouseMove = (e) => {
                if (!dragState.isDragging || dragState.stepIndex === null) return;
                
                e.preventDefault();
                const deltaX = e.clientX - dragState.startX;
                const deltaY = e.clientY - dragState.startY;
                
                setSteps(prevSteps => {
                    const newSteps = [...prevSteps];
                    newSteps[dragState.stepIndex].x = dragState.initialImgX + deltaX;
                    newSteps[dragState.stepIndex].y = dragState.initialImgY + deltaY;
                    return newSteps;
                });
                setHasUnsavedChanges(true);
            };

            const handleImageMouseUp = () => {
                if (dragState.isDragging) {
                    setDragState({ isDragging: false, stepIndex: null, startX: 0, startY: 0, initialImgX: 0, initialImgY: 0 });
                }
            };

            useEffect(() => {
                window.addEventListener('mouseup', handleImageMouseUp);
                window.addEventListener('mousemove', handleImageMouseMove);
                return () => {
                    window.removeEventListener('mouseup', handleImageMouseUp);
                    window.removeEventListener('mousemove', handleImageMouseMove);
                };
            }, [dragState]);

            const handleTextChange = (index, value) => {
                setSteps(prevSteps => {
                    const newSteps = [...prevSteps];
                    newSteps[index].text = value;
                    return newSteps;
                });
                setHasUnsavedChanges(true);
            };

            const deleteStep = (index) => {
                setSteps(prevSteps => prevSteps.filter((_, i) => i !== index));
                setHasUnsavedChanges(true);
            };

            const moveStep = (index, direction) => {
                if ((direction === -1 && index === 0) || (direction === 1 && index === steps.length - 1)) return;
                
                setSteps(prevSteps => {
                    const newSteps = [...prevSteps];
                    const temp = newSteps[index];
                    newSteps[index] = newSteps[index + direction];
                    newSteps[index + direction] = temp;
                    return newSteps;
                });
                setHasUnsavedChanges(true);
            };

            // レイアウト切り替え (横並び <-> 縦並び)
            const toggleLayout = (index) => {
                setSteps(prevSteps => {
                    const newSteps = [...prevSteps];
                    // layoutプロパティが無い場合は 'row' として扱う
                    const currentLayout = newSteps[index].layout || 'row';
                    newSteps[index].layout = currentLayout === 'row' ? 'col' : 'row';
                    return newSteps;
                });
                setHasUnsavedChanges(true);
            };

            const rotateImage = (index) => {
                const step = steps[index];
                const img = new Image();
                img.src = step.image;
                img.onload = () => {
                    const canvas = document.createElement('canvas');
                    canvas.width = img.height;
                    canvas.height = img.width;
                    const ctx = canvas.getContext('2d');
                    ctx.translate(canvas.width / 2, canvas.height / 2);
                    ctx.rotate(90 * Math.PI / 180);
                    ctx.drawImage(img, -img.width / 2, -img.height / 2);
                    const newDataUrl = canvas.toDataURL('image/jpeg');
                    setSteps(prevSteps => {
                        const newSteps = [...prevSteps];
                        newSteps[index].image = newDataUrl;
                        newSteps[index].x = 0;
                        newSteps[index].y = 0;
                        newSteps[index].scale = 1;
                        return newSteps;
                    });
                    setHasUnsavedChanges(true);
                };
            };

            const zoomImage = (index, delta) => {
                setSteps(prevSteps => {
                    const newSteps = [...prevSteps];
                    const currentScale = newSteps[index].scale || 1;
                    let newScale = currentScale + delta;
                    if (newScale < 0.5) newScale = 0.5;
                    if (newScale > 5.0) newScale = 5.0; // 上限を少し緩和
                    newSteps[index].scale = newScale;
                    return newSteps;
                });
                setHasUnsavedChanges(true);
            };

            const resetImage = (index) => {
                setSteps(prevSteps => {
                    const newSteps = [...prevSteps];
                    newSteps[index].scale = 1;
                    newSteps[index].x = 0;
                    newSteps[index].y = 0;
                    return newSteps;
                });
                setHasUnsavedChanges(true);
            }

            const saveData = () => {
                if (steps.length === 0) {
                    alert("保存するデータがありません");
                    return;
                }
                const data = JSON.stringify(steps);
                const blob = new Blob([data], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const link = document.createElement('a');
                link.href = url;
                const name = fileName.trim() || "作業書データ";
                link.download = `${name}.json`;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                setHasUnsavedChanges(false);
            };

            const loadData = (event) => {
                const file = event.target.files[0];
                if (!file) return;

                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const loadedSteps = JSON.parse(e.target.result);
                        if (Array.isArray(loadedSteps)) {
                            if (hasUnsavedChanges && steps.length > 0) {
                                if (!confirm("保存されていない変更があります。上書きしてデータを読み込みますか？")) return;
                            }
                            setSteps(loadedSteps);
                            setHasUnsavedChanges(false);
                        } else {
                            alert("ファイルの形式が正しくありません");
                        }
                    } catch (err) {
                        alert("ファイルの読み込みに失敗しました");
                    }
                };
                reader.readAsText(file);
                event.target.value = '';
            };

            const handlePrint = () => {
                window.print();
            };

            return (
                <div className="min-h-screen bg-gray-50 p-6 font-sans text-gray-800">
                    <div className="max-w-6xl mx-auto space-y-8">
                        
                        {/* Header */}
                        <header className="flex flex-col md:flex-row justify-between items-center border-b pb-4 bg-white p-6 rounded-xl shadow-sm gap-4 print-hidden">
                            <div>
                                <h1 className="text-2xl font-bold flex items-center gap-2 text-indigo-600">
                                    <FileImage className="w-8 h-8" />
                                    画像作業書作成支援ツール
                                </h1>
                                <p className="text-gray-500 text-sm mt-1">画像を読み込み、説明を加えてPDFで出力します</p>
                            </div>
                            <div className="flex flex-wrap gap-2 justify-end items-center">
                                {/* 保存・読込ボタン群 */}
                                <div className="flex items-center gap-2 bg-gray-100 rounded-lg p-2">
                                    <div className="flex flex-col sm:flex-row items-center gap-1">
                                        <label className="text-xs font-bold text-gray-500 whitespace-nowrap">保存名:</label>
                                        <input 
                                            type="text" 
                                            value={fileName}
                                            onChange={(e) => setFileName(e.target.value)}
                                            className="border rounded px-2 py-1 text-sm w-32 focus:outline-none focus:ring-2 focus:ring-indigo-300"
                                            placeholder="作業書データ"
                                        />
                                    </div>
                                    <div className="h-6 w-px bg-gray-300 mx-1"></div>
                                    <button 
                                        onClick={saveData}
                                        disabled={steps.length === 0}
                                        className={`flex items-center gap-1 px-3 py-2 rounded shadow-sm disabled:opacity-50 text-sm whitespace-nowrap transition-colors ${
                                            hasUnsavedChanges && steps.length > 0 
                                            ? "bg-indigo-50 text-indigo-700 border border-indigo-200 font-bold" 
                                            : "bg-white text-gray-700 hover:bg-gray-50"
                                        }`}
                                        title="編集データをPCに保存"
                                    >
                                        <Save className="w-4 h-4" /> 
                                        {hasUnsavedChanges && steps.length > 0 ? "保存*" : "保存"}
                                    </button>
                                    <button onClick={() => jsonInputRef.current?.click()} className="flex items-center gap-1 px-3 py-2 bg-white text-gray-700 rounded shadow-sm hover:bg-gray-50 text-sm whitespace-nowrap" title="編集データを読み込み">
                                        <Upload className="w-4 h-4" /> 読込
                                    </button>
                                    <input type="file" accept=".json" ref={jsonInputRef} className="hidden" onChange={loadData} />
                                </div>

                                {/* 出力ボタン */}
                                <button 
                                    onClick={handlePrint}
                                    className="flex items-center gap-2 px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition-colors text-sm shadow-md whitespace-nowrap"
                                >
                                    <Printer className="w-4 h-4" />
                                    印刷 / PDF保存
                                </button>
                            </div>
                        </header>

                        {/* Main Content Area */}
                        <div className="grid grid-cols-1 lg:grid-cols-3 gap-8 print-block">
                            
                            {/* Left Column: Image Uploader (Sticky) */}
                            <div className="lg:col-span-1 print-hidden">
                                <div className="bg-white rounded-xl shadow-sm p-4 sticky top-6">
                                    <h2 className="font-semibold mb-4 flex items-center gap-2">
                                        <PlusCircle className="w-5 h-5 text-indigo-500" />
                                        画像を追加
                                    </h2>
                                    
                                    <div 
                                        onClick={() => fileInputRef.current?.click()}
                                        onDragOver={handleDragOver}
                                        onDragLeave={handleDragLeave}
                                        onDrop={handleDrop}
                                        className={`border-2 border-dashed rounded-xl h-64 flex flex-col items-center justify-center cursor-pointer transition-colors relative overflow-hidden group ${
                                            isDragging 
                                            ? "border-indigo-500 bg-indigo-50" 
                                            : "border-gray-300 hover:bg-gray-50 hover:border-indigo-300"
                                        }`}
                                    >
                                        <FileImage className={`w-16 h-16 mb-4 transition-colors ${isDragging ? "text-indigo-500" : "text-gray-300 group-hover:text-indigo-400"}`} />
                                        <p className="text-gray-500 font-medium group-hover:text-indigo-600">画像を選択 または ドロップ</p>
                                        <p className="text-xs text-gray-400 mt-2">※複数枚同時に選択できます</p>
                                        <p className="text-xs text-gray-400">対応形式: JPG, PNG, GIFなど</p>
                                    </div>
                                    
                                    <input 
                                        type="file" 
                                        accept="image/*" 
                                        multiple 
                                        ref={fileInputRef}
                                        className="hidden" 
                                        onChange={handleFileUpload}
                                    />
                                    
                                </div>
                            </div>

                            {/* Right Column: Step List */}
                            <div className="lg:col-span-2">
                                <div className="bg-white rounded-xl shadow-sm p-6 min-h-[600px] main-content">
                                    <div className="flex justify-between items-center mb-6 border-b pb-2 print-hidden">
                                        <h2 className="font-semibold flex items-center gap-2 text-lg">
                                            <FileText className="w-5 h-5 text-indigo-500" />
                                            作成された作業項目 ({steps.length})
                                        </h2>
                                        {steps.length === 0 && (
                                            <span className="text-sm text-gray-400">まだ作業項目がありません</span>
                                        )}
                                    </div>

                                    {steps.length === 0 ? (
                                        <div className="flex flex-col items-center justify-center h-96 text-gray-400 print-hidden">
                                            <FileImage className="w-16 h-16 mb-4 text-gray-200" />
                                            <p className="text-lg font-bold text-gray-800">使い方</p>
                                            <div className="text-sm mt-4 space-y-2 text-left bg-gray-50 p-6 rounded-lg max-w-md">
                                                <p>1. 左側のエリアに<b>画像をドロップ</b>するか、クリックして選択します（複数枚OK）。</p>
                                                <p>2. 画像がリストに追加されます。横のテキストボックスに説明を入力します。</p>
                                                <p>3. 画像右下の回転ボタンで<b>画像の向きを調整</b>できます。</p>
                                                <p>4. 右上の矢印ボタンで<b>順番を並べ替え</b>できます。</p>
                                                <p>5. 右上のレイアウトボタンで<b>縦並び（拡大表示）に切り替え</b>られます。</p>
                                                <p>6. 右上の<b>「データ保存」</b>で作業を一時保存できます。</p>
                                                <p>7. 完成したら<b>「印刷 / PDF保存」</b>で書き出します。</p>
                                            </div>
                                        </div>
                                    ) : (
                                        <div className="space-y-8 print:space-y-0">
                                            {steps.map((step, index) => {
                                                const isColLayout = step.layout === 'col';
                                                
                                                return (
                                                <div 
                                                    key={step.id} 
                                                    className={`group relative flex gap-6 p-4 rounded-xl border border-gray-100 hover:border-indigo-100 hover:bg-indigo-50/30 transition-all step-item ${
                                                        isColLayout 
                                                            ? 'flex-col step-col' // 縦並び
                                                            : 'flex-col md:flex-row step-row' // 横並び
                                                    }`}
                                                >
                                                    
                                                    {/* Image Area */}
                                                    <div 
                                                        className={`flex-shrink-0 step-image-container relative cursor-move ${
                                                            isColLayout ? 'w-full' : 'w-full md:w-1/2'
                                                        }`}
                                                        onMouseDown={(e) => handleImageMouseDown(index, e)}
                                                    >
                                                        {/* aspect-videoで固定比率 */}
                                                        <div className={`relative w-full overflow-hidden border border-gray-200 shadow-sm aspect-video bg-gray-100 flex items-center justify-center`}>
                                                            <img 
                                                                src={step.image} 
                                                                alt={`Step ${index + 1}`} 
                                                                className="w-full h-full object-contain transition-transform duration-75 ease-out select-none pointer-events-none" 
                                                                style={{ 
                                                                    transform: `translate(${step.x || 0}px, ${step.y || 0}px) scale(${step.scale || 1})` 
                                                                }}
                                                                draggable="false"
                                                            />
                                                            <div className="absolute top-2 left-2 bg-black/70 text-white text-xs px-2 py-1 rounded-md font-mono z-10 pointer-events-none">
                                                                Step {index + 1}
                                                            </div>
                                                        </div>
                                                        
                                                        {/* Controls Overlay */}
                                                        <div 
                                                            className="absolute bottom-3 right-3 flex gap-2 print-hidden"
                                                            onMouseDown={(e) => e.stopPropagation()} 
                                                        >
                                                            <button 
                                                                onClick={() => resetImage(index)}
                                                                className="bg-white/90 text-gray-700 hover:text-red-500 hover:bg-white shadow-md p-2 rounded-full transition-colors"
                                                                title="位置と拡大をリセット"
                                                            >
                                                                <RefreshCcw className="w-5 h-5" />
                                                            </button>
                                                            <button 
                                                                onClick={() => zoomImage(index, -0.1)}
                                                                className="bg-white/90 text-gray-700 hover:text-indigo-600 hover:bg-white shadow-md p-2 rounded-full transition-colors"
                                                                title="縮小"
                                                            >
                                                                <ZoomOut className="w-5 h-5" />
                                                            </button>
                                                            <button 
                                                                onClick={() => zoomImage(index, 0.1)}
                                                                className="bg-white/90 text-gray-700 hover:text-indigo-600 hover:bg-white shadow-md p-2 rounded-full transition-colors"
                                                                title="拡大"
                                                            >
                                                                <ZoomIn className="w-5 h-5" />
                                                            </button>
                                                            <button 
                                                                onClick={() => rotateImage(index)}
                                                                className="bg-white/90 text-gray-700 hover:text-indigo-600 hover:bg-white shadow-md p-2 rounded-full transition-colors"
                                                                title="画像を90度回転"
                                                            >
                                                                <RotateCw className="w-5 h-5" />
                                                            </button>
                                                        </div>
                                                    </div>

                                                    {/* Text Area */}
                                                    <div className={`flex flex-col gap-2 step-text-container ${
                                                        isColLayout ? 'w-full' : 'w-full md:w-1/2'
                                                    }`}>
                                                        <textarea
                                                            value={step.text}
                                                            onChange={(e) => handleTextChange(index, e.target.value)}
                                                            className="w-full h-full min-h-[120px] p-3 rounded-lg border border-gray-200 focus:border-indigo-500 focus:ring-2 focus:ring-indigo-200 outline-none resize-none text-gray-700 leading-relaxed"
                                                            placeholder="作業の説明を入力してください..."
                                                        />
                                                    </div>

                                                    {/* Controls (Move, Layout, Delete) */}
                                                    <div className="absolute -top-3 -right-3 flex gap-1 print-hidden">
                                                        {/* レイアウト切り替えボタン */}
                                                        <button
                                                            onClick={() => toggleLayout(index)}
                                                            className={`bg-white border shadow-sm p-1.5 rounded-md transition-colors mr-2 ${
                                                                isColLayout 
                                                                ? "text-indigo-600 border-indigo-200 bg-indigo-50" 
                                                                : "text-gray-500 hover:text-indigo-600"
                                                            }`}
                                                            title={isColLayout ? "横並びに戻す" : "画像を大きく表示（縦並び）"}
                                                        >
                                                            {isColLayout ? <LayoutRow className="w-4 h-4" /> : <LayoutCol className="w-4 h-4" />}
                                                        </button>

                                                        <button 
                                                            onClick={() => moveStep(index, -1)}
                                                            disabled={index === 0}
                                                            className="bg-white text-gray-500 hover:text-indigo-600 border shadow-sm p-1.5 rounded-md disabled:opacity-30 disabled:cursor-not-allowed transition-colors"
                                                            title="上へ移動"
                                                        >
                                                            <ArrowUp className="w-4 h-4" />
                                                        </button>
                                                        <button 
                                                            onClick={() => moveStep(index, 1)}
                                                            disabled={index === steps.length - 1}
                                                            className="bg-white text-gray-500 hover:text-indigo-600 border shadow-sm p-1.5 rounded-md disabled:opacity-30 disabled:cursor-not-allowed transition-colors"
                                                            title="下へ移動"
                                                        >
                                                            <ArrowDown className="w-4 h-4" />
                                                        </button>
                                                        <button 
                                                            onClick={() => deleteStep(index)}
                                                            className="bg-white text-gray-400 hover:text-red-500 border shadow-sm p-1.5 rounded-md transition-colors"
                                                            title="この作業を削除"
                                                        >
                                                            <Trash2 className="w-4 h-4" />
                                                        </button>
                                                    </div>
                                                </div>
                                            );
                                            })}
                                        </div>
                                    )}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>